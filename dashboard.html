<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard - Aman Behera</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        .dashboard-container {
            max-width: 1200px;
            margin: 120px auto 60px;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--walter-green);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .visitors-table {
            width: 100%;
            border-collapse: collapse;
            margin: 40px 0;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .visitors-table th {
            background: var(--bg-tertiary);
            padding: 15px;
            text-align: left;
            font-weight: 500;
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .visitors-table td {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        
        .visitors-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .map-container {
            width: 100%;
            height: 400px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin: 40px 0;
            overflow: hidden;
        }
        
        #visitor-map {
            width: 100%;
            height: 100%;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-family: 'IBM Plex Sans', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .filter-btn:hover,
        .filter-btn.active {
            background: var(--walter-green);
            color: #ffffff;
            border-color: var(--walter-green);
        }
        
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .error-message {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 40px 0;
            color: #ff3b30;
        }
        
        .auth-container {
            max-width: 400px;
            margin: 200px auto;
            padding: 40px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: 'IBM Plex Sans', monospace;
            color: var(--text-primary);
        }
        
        .auth-form button {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background: var(--walter-green);
            color: #ffffff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'IBM Plex Sans', monospace;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav id="navbar" role="navigation" aria-label="Main navigation">
        <div class="nav-container">
            <div class="nav-left">
                <a href="index.html" class="nav-logo" aria-label="Home">Aman Behera</a>
                <button id="theme-toggle" class="theme-toggle" onclick="toggleDarkMode()" aria-label="Toggle theme">
                    <span id="theme-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                        </svg>
                    </span>
                </button>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="work.html">Work</a></li>
                <li><a href="blogs.html">Blogs</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
            </ul>
        </div>
    </nav>

    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container" style="display: none;">
        <h2>Analytics Dashboard</h2>
        <p style="color: var(--text-muted); margin: 20px 0;">Sign in to view visitor analytics</p>
        <form class="auth-form" id="auth-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password" required>
            <button type="submit">Sign In</button>
        </form>
        <p id="auth-error" style="color: #ff3b30; margin-top: 15px; display: none;"></p>
    </div>

    <!-- Dashboard Container -->
    <div id="dashboard-container" class="dashboard-container" style="display: none;">
        <h1 data-hex="0x00" data-subtitle="Visitor metrics and insights.">Analytics Dashboard</h1>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Visits</div>
                <div class="stat-value" id="total-visits">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Unique Sessions</div>
                <div class="stat-value" id="unique-sessions">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Countries</div>
                <div class="stat-value" id="countries">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Today</div>
                <div class="stat-value" id="today-visits">-</div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" data-period="24h">Last 24 Hours</button>
            <button class="filter-btn" data-period="7d">Last 7 Days</button>
            <button class="filter-btn" data-period="30d">Last 30 Days</button>
            <button class="filter-btn" data-period="all">All Time</button>
        </div>

        <!-- Visitor Map -->
        <h2 style="margin-top: 40px;">Visitor Locations</h2>
        <div class="map-container">
            <div id="visitor-map"></div>
        </div>

        <!-- Recent Visitors Table -->
        <h2 style="margin-top: 60px;">Recent Visitors</h2>
        <table class="visitors-table">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Page</th>
                    <th>Location</th>
                    <th>Device</th>
                    <th>Browser</th>
                </tr>
            </thead>
            <tbody id="visitors-tbody">
                <tr>
                    <td colspan="5" class="loading">Loading visitor data...</td>
                </tr>
            </tbody>
        </table>

        <button onclick="signOut()" style="margin: 40px 0; padding: 10px 20px; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary); font-family: 'IBM Plex Sans', monospace;">Sign Out</button>
    </div>

    <!-- Ring Buffer Scrollbar -->
    <div id="ring-buffer" class="ring-buffer"></div>

    <script src="js/main.js"></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Configuration
        const SUPABASE_URL = 'https://jmqhgcssvewlkswqymby.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_7P2hm337Qv53_IUaWxm_Mw_qJifHVRa';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentPeriod = '24h';

        // Check authentication on load
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                showDashboard();
                loadAnalytics();
            } else {
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-container').style.display = 'block';
            document.getElementById('dashboard-container').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
        }

        // Sign in
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorEl = document.getElementById('auth-error');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) throw error;
                
                showDashboard();
                loadAnalytics();
            } catch (error) {
                errorEl.textContent = error.message;
                errorEl.style.display = 'block';
            }
        });

        // Sign out
        window.signOut = async function() {
            await supabase.auth.signOut();
            showAuth();
        };

        // Load analytics data
        async function loadAnalytics() {
            try {
                const cutoffTime = getCutoffTime(currentPeriod);
                
                // Fetch total stats
                const { data: visitors, error } = await supabase
                    .from('visitors')
                    .select('*')
                    .gte('timestamp', cutoffTime)
                    .order('timestamp', { ascending: false });

                if (error) throw error;

                // Calculate stats
                const totalVisits = visitors.length;
                const uniqueSessions = new Set(visitors.map(v => v.session_id)).size;
                const countries = new Set(visitors.map(v => v.country).filter(Boolean)).size;
                
                const today = new Date().toISOString().split('T')[0];
                const todayVisits = visitors.filter(v => v.timestamp.startsWith(today)).length;

                // Update UI
                document.getElementById('total-visits').textContent = totalVisits;
                document.getElementById('unique-sessions').textContent = uniqueSessions;
                document.getElementById('countries').textContent = countries;
                document.getElementById('today-visits').textContent = todayVisits;

                // Populate table
                const tbody = document.getElementById('visitors-tbody');
                tbody.innerHTML = visitors.slice(0, 50).map(v => `
                    <tr>
                        <td>${new Date(v.timestamp).toLocaleString()}</td>
                        <td>${v.page}</td>
                        <td>${v.city || 'Unknown'}, ${v.country || 'Unknown'}</td>
                        <td>${v.device_type || 'Unknown'}</td>
                        <td>${v.browser || 'Unknown'}</td>
                    </tr>
                `).join('');

                // Update map with visitor locations
                updateMap(visitors);

            } catch (error) {
                console.error('Failed to load analytics:', error);
                document.getElementById('visitors-tbody').innerHTML = `
                    <tr><td colspan="5" class="error-message">Failed to load analytics data</td></tr>
                `;
            }
        }

        // Get cutoff time based on period
        function getCutoffTime(period) {
            const now = new Date();
            switch(period) {
                case '24h':
                    return new Date(now.getTime() - 24 * 60 * 60 * 1000).toISOString();
                case '7d':
                    return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000).toISOString();
                case '30d':
                    return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000).toISOString();
                default:
                    return '2000-01-01T00:00:00Z';
            }
        }

        // Initialize map
        let map;
        let markerLayer;

        function initMap() {
            map = L.map('visitor-map').setView([20, 0], 2);
            
            // Add dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            markerLayer = L.layerGroup().addTo(map);
        }

        function updateMap(visitors) {
            if (!map) initMap();
            
            // Clear existing markers
            markerLayer.clearLayers();
            
            // Group visitors by location
            const locationCounts = {};
            visitors.forEach(v => {
                if (v.latitude && v.longitude) {
                    const key = `${v.latitude},${v.longitude}`;
                    locationCounts[key] = locationCounts[key] || { 
                        lat: v.latitude, 
                        lon: v.longitude, 
                        city: v.city, 
                        country: v.country, 
                        count: 0 
                    };
                    locationCounts[key].count++;
                }
            });

            // Add markers
            Object.values(locationCounts).forEach(loc => {
                const marker = L.circleMarker([loc.lat, loc.lon], {
                    radius: Math.min(5 + Math.log(loc.count) * 3, 20),
                    fillColor: '#6b8cff',
                    color: '#ffffff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.7
                }).addTo(markerLayer);

                marker.bindPopup(`
                    <strong>${loc.city}, ${loc.country}</strong><br>
                    ${loc.count} visit${loc.count > 1 ? 's' : ''}
                `);
            });
        }

        // Period filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentPeriod = btn.dataset.period;
                loadAnalytics();
            });
        });

        // Initialize
        checkAuth();
    </script>
</body>
</html>
